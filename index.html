<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบทดสอบรายวิชาการพยาบาลผู้สูงอายุ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // เพิ่ม import: setPersistence, browserSessionPersistence
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ==========================================
        //  ENVIRONMENT VARIABLES
        // ==========================================
        const ENV = {
            FIREBASE_CONFIG: {
                apiKey: "AIzaSyDQBM66YRLXmtFx7lynCBrL2qty9HNd57o",
                authDomain: "loinby-cfdfe.firebaseapp.com",
                projectId: "loinby-cfdfe",
                storageBucket: "loinby-cfdfe.firebasestorage.app",
                messagingSenderId: "605737719385",
                appId: "1:605737719385:web:5a08679d76f7bb23cdc348"
            },
            API_URL: "https://script.google.com/macros/s/AKfycbxvwe9U49mrbwwWXOdNBlTbxQ_RMhwl0Fg3uEeu60vU-04LoI7JLgW2iQDWt5MSgv33/exec",
            EXAM_SETTINGS: {
                ENABLE_POSTTEST: false,    
                ENABLE_SHOW_ANSWER: true,  
                ENABLE_RETAKE: true        
            }
        };

        const appme = initializeApp(ENV.FIREBASE_CONFIG);
        const auth = getAuth(appme);
        
        // --- SECURITY: ตั้งค่าให้ล็อกอินหลุดทันทีเมื่อปิดแท็บ/เบราว์เซอร์ ---
        setPersistence(auth, browserSessionPersistence)
            .then(() => {
                // Persistence set to session successfully
                console.log("Session persistence enabled");
            })
            .catch((error) => {
                console.error("Auth Persistence Error:", error);
            });

        const provider = new GoogleAuthProvider();
        auth.languageCode = 'th'; 

        // --- Global Auth Functions ---
        window.loginWithGoogle = () => {
            // [TEST MODE] บังคับให้ถามสิทธิ์ (Consent) และเลือกบัญชีใหม่ทุกครั้ง
            // ลบบรรทัดนี้ออกเมื่อทดสอบเสร็จ หากต้องการให้จำสิทธิ์เดิม
            provider.setCustomParameters({
                prompt: 'select_account consent'
            });

            // การเรียก signInWithPopup จะใช้ค่า Persistence ที่ตั้งไว้ข้างบน
            signInWithPopup(auth, provider)
                .catch((error) => {
                    console.error("Login Error:", error);
                    
                    if (error.code === 'auth/cancelled-popup-request' || error.code === 'auth/popup-closed-by-user') {
                        return; 
                    }

                    Swal.fire({
                        icon: 'error',
                        title: 'เข้าสู่ระบบไม่สำเร็จ',
                        text: error.message,
                        confirmButtonColor: '#0369a1'
                    });
                });
        };

        window.logoutFirebase = () => {
            Swal.fire({
                title: 'ออกจากระบบ?',
                text: "คุณต้องการลงชื่อออกใช่หรือไม่",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#0369a1',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'ใช่, ออกจากระบบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    signOut(auth).then(() => {
                        location.reload();
                    });
                }
            });
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const name = user.displayName;
                const email = user.email;
                
                renderLoading(`กำลังตรวจสอบประวัติของ ${name}...`);
                
                const result = await checkUserStatus(email);
                
                currentState.user = name; 
                currentState.userId = email;
                currentState.photoURL = user.photoURL;
                currentState.realName = name; 
                currentState.studentId = '';

                if (result) {
                    if (result.pretest && result.pretest.found) {
                        currentState.pretestData = {
                            isDone: true,
                            score: result.pretest.score,
                            answers: JSON.parse(result.pretest.answers || '{}')
                        };
                    }
                    if (result.posttest && result.posttest.found) {
                        currentState.posttestData = {
                            isDone: true,
                            score: result.posttest.score,
                            answers: JSON.parse(result.posttest.answers || '{}')
                        };
                    }
                }
                
                currentState.view = 'register';
                renderApp();
            }
        });

        window.APP_ENV = ENV;
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nursing: {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc',
                            400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1',
                            800: '#075985', 900: '#0c4a6e',
                        }
                    },
                    fontFamily: {
                        sans: ['Sarabun', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc;
            background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 40px 40px;
        }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nursing-shadow { box-shadow: 0 4px 6px -1px rgba(12, 74, 110, 0.1), 0 2px 4px -1px rgba(12, 74, 110, 0.06); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .loader {
            width: 48px; height: 48px; border: 5px solid #e0f2fe; border-bottom-color: #0369a1;
            border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        div:where(.swal2-container) {
            font-family: 'Sarabun', sans-serif !important;
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4"></div>

    <script>
        const app = document.getElementById('app');
        
        let currentState = {
            view: 'login', user: '', userId: '', photoURL: '',
            quizType: 'pretest', 
            currentQuestionIndex: 0, 
            answers: {}, 
            score: 0, 
            realName: '', studentId: '',
            currentExamData: [],
            pretestQuestions: null,
            posttestQuestions: null,
            pretestData: { isDone: false, score: 0, answers: {} },
            posttestData: { isDone: false, score: 0, answers: {} },
            isLoading: false
        };

        // --- API Functions ---
        function getApiUrl() { return window.APP_ENV ? window.APP_ENV.API_URL : ""; }
        function getExamSettings() { return window.APP_ENV ? window.APP_ENV.EXAM_SETTINGS : { ENABLE_POSTTEST: false, ENABLE_SHOW_ANSWER: true, ENABLE_RETAKE: true }; }

        async function checkUserStatus(email) {
            const url = getApiUrl();
            if (!url) return null;
            try {
                const response = await fetch(`${url}?action=check&username=${encodeURIComponent(email)}`);
                return await response.json();
            } catch (error) {
                console.error("Error checking user:", error);
                return null;
            }
        }

        async function fetchQuestions(type) {
            const url = getApiUrl();
            if (!url) return [];
            try {
                const response = await fetch(`${url}?action=getQuestions&quizType=${type}`);
                return await response.json();
            } catch (error) {
                console.error("Error fetching questions:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'ข้อผิดพลาด',
                    text: 'ไม่สามารถเชื่อมต่อเพื่อดึงข้อสอบได้',
                    confirmButtonColor: '#0369a1'
                });
                return [];
            }
        }

        async function saveUserData(payload) {
            const url = getApiUrl();
            if (!url) return;
            const formData = new FormData();
            formData.append('action', 'send');
            formData.append('username', payload.userId);
            formData.append('realName', payload.realName);
            formData.append('studentId', payload.studentId);
            formData.append('quizType', payload.quizType);
            formData.append('score', payload.score);
            formData.append('total', payload.total);
            formData.append('answers', JSON.stringify(payload.answers));

            try {
                const response = await fetch(url, { method: 'POST', body: formData });
                return await response.json();
            } catch (error) {
                console.error("Error saving:", error);
                return { result: "error" };
            }
        }

        // --- Render Functions ---

        function renderLoading(message = "กำลังโหลดข้อมูล...") {
            app.innerHTML = `
                <div class="flex flex-col items-center justify-center fade-in">
                    <span class="loader mb-6"></span>
                    <p class="text-nursing-800 font-semibold text-lg animate-pulse">${message}</p>
                </div>
            `;
        }

        function renderLogin() {
            app.innerHTML = `
                <div class="glass-panel rounded-2xl nursing-shadow p-10 w-full max-w-md fade-in border-t-8 border-nursing-700">
                    <div class="text-center mb-8">
                        <div class="flex justify-center mb-6">
                            <img src="https://www.kcn.ac.th/storage/app/media/images/logo/logo_kcn.png" 
                                 alt="KCN Logo" 
                                 class="h-28 object-contain drop-shadow-md hover:scale-105 transition-transform duration-300">
                        </div>
                        <h1 class="text-2xl font-bold text-nursing-900 tracking-tight">เข้าสู่ระบบสอบ</h1>
                        <p class="text-slate-500 mt-2 font-medium">รายวิชาการพยาบาลผู้สูงอายุ</p>
                    </div>
                    
                    <button onclick="loginWithGoogle()" 
                        class="w-full bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 hover:border-slate-400 font-bold py-3.5 rounded-lg transition-all shadow-sm flex items-center justify-center gap-3">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                        ลงชื่อเข้าใช้ด้วย Google
                    </button>
                    
                    <div class="mt-8 flex items-center justify-center gap-2 text-xs text-slate-400">
                        <i data-lucide="shield-check" class="w-4 h-4"></i>
                        <span>ระบบยืนยันตัวตนปลอดภัย</span>
                    </div>
                </div>
            `;
            if(window.lucide) lucide.createIcons();
        }

        function renderRegister() {
            app.innerHTML = `
                <div class="glass-panel rounded-2xl nursing-shadow p-8 w-full max-w-md fade-in border-t-8 border-nursing-700">
                    <div class="text-center mb-8 border-b border-slate-200 pb-4">
                        <h2 class="text-xl font-bold text-nursing-900">ลงทะเบียนข้อมูลผู้สอบ</h2>
                        <p class="text-slate-500 text-sm mt-1">กรุณาระบุข้อมูลจริงเพื่อการบันทึกผลคะแนน</p>
                    </div>
                    <form id="registerForm" class="space-y-5">
                        <div>
                            <label class="block text-sm font-bold text-nursing-800 mb-2">ชื่อ-นามสกุล (ภาษาไทย)</label>
                            <input type="text" id="realNameInput" required value="${currentState.realName}" 
                                class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-nursing-500 focus:border-nursing-500 focus:outline-none transition" 
                                placeholder="เช่น นางสาวใจดี มีสุข">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-nursing-800 mb-2">รหัสนักศึกษา</label>
                            <input type="text" id="studentIdInput" required value="${currentState.studentId}"
                                class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-nursing-500 focus:border-nursing-500 focus:outline-none transition" 
                                placeholder="ระบุรหัสนักศึกษา">
                        </div>
                        <button type="submit" 
                            class="w-full bg-nursing-700 hover:bg-nursing-800 text-white font-bold py-3.5 rounded-lg transition-all shadow-md mt-4 flex justify-center items-center gap-2">
                            บันทึกข้อมูล <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </form>
                </div>
            `;
            lucide.createIcons();
            
            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                currentState.realName = document.getElementById('realNameInput').value.trim();
                currentState.studentId = document.getElementById('studentIdInput').value.trim();
                
                if(!currentState.realName || !currentState.studentId) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'ข้อมูลไม่ครบถ้วน',
                        text: 'กรุณากรอกชื่อและรหัสนักศึกษาให้ครบถ้วน',
                        confirmButtonColor: '#0369a1'
                    });
                    return;
                }
                currentState.view = 'menu';
                renderApp();
            });
        }

        function renderMenu() {
            const SETTINGS = getExamSettings();
            const profileImg = currentState.photoURL 
                ? `<img src="${currentState.photoURL}" class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-white shadow-md object-cover">`
                : `<div class="bg-white/20 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm border-2 border-white/50 shadow-lg"><i data-lucide="user" class="w-10 h-10 text-white"></i></div>`;

            // --- Pretest Block ---
            let pretestHtml = '';
            const pre = currentState.pretestData;
            
            if (pre.isDone) {
                let btns = '';
                if (SETTINGS.ENABLE_SHOW_ANSWER) {
                    btns += `<button onclick="reviewQuiz('pretest')" class="text-xs bg-white border border-slate-200 text-nursing-700 px-3 py-2 rounded shadow-sm hover:bg-slate-50 flex items-center gap-1 transition"><i data-lucide="eye" class="w-3 h-3"></i> ดูเฉลย</button>`;
                }
                if (SETTINGS.ENABLE_RETAKE) {
                    btns += `<button onclick="startQuiz('pretest')" class="text-xs bg-nursing-50 text-nursing-700 border border-nursing-200 px-3 py-2 rounded shadow-sm hover:bg-nursing-100 flex items-center gap-1 transition"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> สอบแก้ตัว</button>`;
                }

                pretestHtml = `
                    <div class="bg-white border-l-4 border-green-500 rounded-r-lg shadow-sm p-5 mb-4 relative overflow-hidden">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                                    Pre-test <span class="text-xs font-normal text-slate-500">(ก่อนเรียน)</span>
                                </h4>
                                <span class="inline-flex items-center gap-1 text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded mt-1">
                                    <i data-lucide="check-circle" class="w-3 h-3"></i> ดำเนินการแล้ว
                                </span>
                            </div>
                            <div class="text-right">
                                <span class="text-3xl font-bold text-slate-800">${pre.score}</span>
                                <span class="text-xs text-slate-500 block">คะแนนที่ได้</span>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-4 pt-3 border-t border-slate-100">
                            ${btns}
                        </div>
                    </div>
                `;
            } else {
                pretestHtml = `
                    <div class="bg-white border-l-4 border-nursing-500 rounded-r-lg shadow-sm p-5 mb-4 hover:shadow-md transition duration-200">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-slate-800 text-lg">Pre-test <span class="text-xs font-normal text-slate-500">(ก่อนเรียน)</span></h4>
                            <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded">ยังไม่ได้สอบ</span>
                        </div>
                        <button onclick="startQuiz('pretest')" class="w-full bg-nursing-600 hover:bg-nursing-700 text-white font-bold py-2.5 rounded-lg transition shadow flex items-center justify-center gap-2">
                            <i data-lucide="play-circle" class="w-4 h-4"></i> เริ่มทำแบบทดสอบ
                        </button>
                    </div>
                `;
            }

            // --- Posttest Block ---
            let posttestHtml = '';
            const post = currentState.posttestData;

            if (!SETTINGS.ENABLE_POSTTEST) {
                posttestHtml = `
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-5 text-left opacity-70 relative">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-slate-500 text-lg">Post-test <span class="text-xs font-normal">(หลังเรียน)</span></h4>
                            <i data-lucide="lock" class="w-5 h-5 text-slate-400"></i>
                        </div>
                        <p class="text-xs text-slate-400 mt-2">ยังไม่เปิดให้ทำแบบทดสอบนี้</p>
                    </div>
                `;
            } else {
                if (post.isDone) {
                    let btns = '';
                    if (SETTINGS.ENABLE_SHOW_ANSWER) {
                        btns += `<button onclick="reviewQuiz('posttest')" class="text-xs bg-white border border-slate-200 text-nursing-700 px-3 py-2 rounded shadow-sm hover:bg-slate-50 flex items-center gap-1 transition"><i data-lucide="eye" class="w-3 h-3"></i> ดูเฉลย</button>`;
                    }

                    posttestHtml = `
                        <div class="bg-white border-l-4 border-blue-600 rounded-r-lg shadow-sm p-5 relative overflow-hidden">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                                        Post-test <span class="text-xs font-normal text-slate-500">(หลังเรียน)</span>
                                    </h4>
                                    <span class="inline-flex items-center gap-1 text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded mt-1">
                                        <i data-lucide="check-circle" class="w-3 h-3"></i> ดำเนินการแล้ว
                                    </span>
                                </div>
                                <div class="text-right">
                                    <span class="text-3xl font-bold text-slate-800">${post.score}</span>
                                    <span class="text-xs text-slate-500 block">คะแนนที่ได้</span>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-4 pt-3 border-t border-slate-100">
                                ${btns}
                            </div>
                        </div>
                    `;
                } else {
                    posttestHtml = `
                        <div class="bg-white border-l-4 border-nursing-700 rounded-r-lg shadow-sm p-5 hover:shadow-md transition duration-200">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-slate-800 text-lg">Post-test <span class="text-xs font-normal text-slate-500">(หลังเรียน)</span></h4>
                                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-medium">เปิดสอบแล้ว</span>
                            </div>
                            <button onclick="startQuiz('posttest')" class="w-full bg-nursing-800 hover:bg-nursing-900 text-white font-bold py-2.5 rounded-lg transition shadow flex items-center justify-center gap-2">
                                <i data-lucide="play-circle" class="w-4 h-4"></i> เริ่มทำแบบทดสอบ
                            </button>
                        </div>
                    `;
                }
            }

            app.innerHTML = `
                <div class="w-full max-w-md fade-in flex flex-col justify-center">
                    <div class="glass-panel rounded-2xl nursing-shadow overflow-hidden mb-6">
                        <!-- Header Profile -->
                        <div class="bg-gradient-to-r from-nursing-800 to-nursing-600 p-8 text-white text-center relative">
                            <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/medical-icons.png')]"></div>
                            <div class="relative z-10">
                                ${profileImg}
                                <h2 class="text-xl font-bold tracking-wide">${currentState.realName || currentState.user}</h2>
                                <p class="text-nursing-100 text-sm mt-1 font-light">รหัส: ${currentState.studentId || '-'}</p>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-6 bg-slate-50/50">
                             ${pretestHtml}
                             ${posttestHtml}
                        </div>
                    </div>
                     <button onclick="logoutFirebase()" class="text-slate-400 hover:text-nursing-700 text-sm font-medium transition flex items-center justify-center gap-2 mx-auto py-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i> ออกจากระบบ
                     </button>
                </div>
            `;
            lucide.createIcons();
        }

        function renderQuiz() {
            const questions = currentState.currentExamData;
            
            if (!questions || questions.length === 0) {
                app.innerHTML = `<div class="text-center p-8 text-slate-500">กำลังโหลดข้อสอบหรือเกิดข้อผิดพลาด...</div>`;
                return;
            }

            const question = questions[currentState.currentQuestionIndex];
            const progress = ((currentState.currentQuestionIndex + 1) / questions.length) * 100;
            const isLastQuestion = currentState.currentQuestionIndex === questions.length - 1;
            const currentAnswer = currentState.answers[currentState.currentQuestionIndex];
            const hasAnsweredCurrent = currentAnswer !== undefined; 
            
            const isReviewMode = (currentState.quizType === 'pretest' && currentState.pretestData.isDone) || 
                                 (currentState.quizType === 'posttest' && currentState.posttestData.isDone);

            const typeLabel = currentState.quizType === 'pretest' ? 'Pre-test' : 'Post-test';
            const title = isReviewMode ? `เฉลย ${typeLabel}` : `ข้อสอบ ${typeLabel}`;

            let optionsHtml = '';
            question.options.forEach((opt, idx) => {
                const isSelected = currentAnswer === idx;
                const isCorrect = idx === question.correctAnswer;
                
                // Styles logic
                let containerClass = "border-slate-200 bg-white hover:border-nursing-300 hover:bg-slate-50";
                let circleClass = "border-slate-300 text-transparent";
                let icon = "";

                if (isReviewMode) {
                    containerClass = "cursor-default border-slate-200 bg-white opacity-60"; // Default dimmed
                    
                    if (isSelected) {
                        if (isCorrect) {
                            containerClass = "border-green-500 bg-green-50 opacity-100 ring-1 ring-green-500";
                            circleClass = "border-green-500 bg-green-500 text-white";
                            icon = `<i data-lucide="check-circle" class="w-5 h-5 text-green-600 ml-2"></i>`;
                        } else {
                            containerClass = "border-red-500 bg-red-50 opacity-100 ring-1 ring-red-500";
                            circleClass = "border-red-500 bg-red-500 text-white";
                            icon = `<i data-lucide="x-circle" class="w-5 h-5 text-red-600 ml-2"></i>`;
                        }
                    } else if (isCorrect) {
                        containerClass = "border-green-500 bg-green-50 opacity-100";
                        circleClass = "border-green-500 bg-green-500 text-white";
                        icon = `<i data-lucide="check" class="w-5 h-5 text-green-600 ml-2"></i>`;
                    }
                } else {
                    // Normal Mode
                    if (isSelected) {
                        containerClass = "border-nursing-600 bg-nursing-50 ring-1 ring-nursing-600 text-nursing-900 font-medium shadow-sm";
                        circleClass = "border-nursing-600 bg-nursing-600 text-white";
                    }
                }

                optionsHtml += `
                    <button onclick="${isReviewMode ? '' : `selectAnswer(${idx})`}"
                        class="w-full text-left p-4 rounded-xl border transition-all duration-200 flex items-start mb-3 group ${containerClass}">
                        <div class="w-6 h-6 rounded-full border mr-3 flex items-center justify-center flex-shrink-0 mt-0.5 transition-colors ${circleClass}">
                            <i data-lucide="check" class="w-3 h-3"></i>
                        </div>
                        <span class="text-sm md:text-base leading-relaxed flex-grow">${opt}</span>
                        ${icon}
                    </button>
                `;
            });

            app.innerHTML = `
                <div class="w-full max-w-3xl flex flex-col min-h-screen sm:min-h-0 sm:h-auto fade-in">
                    <!-- Header Bar -->
                    <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-bold text-nursing-800 flex items-center gap-2">
                            <i data-lucide="clipboard-list" class="w-5 h-5 text-nursing-600"></i>
                            ${title}
                        </h2>
                        <span class="bg-nursing-100 text-nursing-800 px-3 py-1 rounded-full text-xs font-bold">
                            ข้อที่ ${currentState.currentQuestionIndex + 1} / ${questions.length}
                        </span>
                    </div>

                    <!-- Progress Bar -->
                    <div class="w-full bg-slate-200 rounded-full h-2.5 mb-6">
                        <div class="bg-nursing-600 h-2.5 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                    </div>

                    <!-- Question Card -->
                    <div class="bg-white rounded-2xl nursing-shadow p-6 md:p-8 mb-6 flex-grow border border-slate-100 relative overflow-hidden">
                         <div class="absolute -top-6 -right-6 opacity-5 rotate-12">
                            <i data-lucide="stethoscope" class="w-40 h-40 text-nursing-900"></i>
                         </div>
                        <h3 class="text-lg md:text-xl font-bold text-slate-800 mb-6 leading-relaxed relative z-10">
                            ${currentState.currentQuestionIndex + 1}. ${question.question}
                        </h3>
                        <div class="space-y-3 relative z-10">${optionsHtml}</div>
                    </div>

                    <!-- Controls -->
                    <div class="flex justify-between items-center mt-auto pt-2 pb-8 sm:pb-0">
                         ${isReviewMode ? `
                             <button onclick="backToMenu()" 
                                class="px-5 py-2.5 rounded-lg font-bold text-slate-600 bg-white border border-slate-300 hover:bg-slate-50 transition shadow-sm text-sm">
                                ออกจากหน้าเฉลย
                            </button>
                         ` : `
                             <button onclick="prevQuestion()" 
                                class="px-5 py-2.5 rounded-lg font-bold transition flex items-center gap-2 text-sm
                                ${currentState.currentQuestionIndex === 0 ? 'text-slate-300 cursor-not-allowed' : 'text-slate-600 bg-white hover:bg-slate-50 border border-slate-300 shadow-sm'}"
                                ${currentState.currentQuestionIndex === 0 ? 'disabled' : ''}>
                                <i data-lucide="chevron-left" class="w-4 h-4"></i> ย้อนกลับ
                            </button>
                         `}
                        <div class="flex gap-2">
                             ${currentState.currentQuestionIndex > 0 && isReviewMode ? `
                                <button onclick="prevQuestion()" class="px-3 py-2.5 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 text-slate-600"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                             ` : ''}
                            ${isLastQuestion ? (isReviewMode ? '' : `
                                <button onclick="submitQuiz()" id="submitBtn" ${!hasAnsweredCurrent ? 'disabled' : ''}
                                    class="px-6 py-2.5 rounded-lg font-bold text-white transition-all shadow-md flex items-center gap-2 text-sm
                                    ${!hasAnsweredCurrent ? 'bg-slate-300 cursor-not-allowed' : 'bg-nursing-600 hover:bg-nursing-700 transform hover:-translate-y-0.5'}">
                                    ส่งคำตอบ <i data-lucide="send" class="w-4 h-4"></i>
                                </button>
                            `) : `
                                <button onclick="nextQuestion()" ${!hasAnsweredCurrent && !isReviewMode ? 'disabled' : ''}
                                    class="px-6 py-2.5 rounded-lg font-bold text-white transition-all shadow-md flex items-center gap-2 text-sm
                                    ${(!hasAnsweredCurrent && !isReviewMode) ? 'bg-slate-300 cursor-not-allowed' : 'bg-nursing-600 hover:bg-nursing-700 transform hover:-translate-y-0.5'}">
                                    ${isReviewMode ? 'ข้อถัดไป' : 'ถัดไป'} <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderResult() {
            let score = currentState.score;
            let typeLabel = currentState.quizType === 'pretest' ? 'Pre-test' : 'Post-test';
            let total = currentState.currentExamData.length;

            app.innerHTML = `
                <div class="w-full max-w-2xl fade-in text-center">
                    <div class="glass-panel rounded-2xl nursing-shadow p-10 mb-8 border-t-8 border-nursing-600">
                        <div class="w-24 h-24 bg-nursing-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner ring-4 ring-white">
                            <i data-lucide="award" class="w-12 h-12 text-nursing-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-nursing-900 mb-2">บันทึกผลคะแนนเรียบร้อย</h2>
                        <p class="text-slate-500 mb-8 font-medium">การสอบ ${typeLabel} ของคุณเสร็จสมบูรณ์</p>
                        
                        <div class="flex justify-center items-end gap-2 mb-2">
                            <span class="text-7xl font-bold text-nursing-700 tracking-tighter leading-none">${score}</span>
                            <span class="text-xl text-slate-400 font-medium mb-2">/ ${total}</span>
                        </div>
                        <div class="text-nursing-500 font-bold text-sm uppercase tracking-widest bg-nursing-50 inline-block px-4 py-1 rounded-full">คะแนนรวม</div>
                    </div>
                    <div class="mt-8">
                        <button onclick="backToMenu()" class="bg-white text-nursing-700 border border-nursing-200 hover:border-nursing-400 hover:bg-nursing-50 px-8 py-3 rounded-lg font-bold shadow-sm transition-all flex items-center justify-center gap-2 mx-auto">
                            <i data-lucide="home" class="w-4 h-4"></i> กลับสู่หน้าหลัก
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderApp() {
            if (currentState.view === 'login') renderLogin();
            else if (currentState.view === 'register') renderRegister();
            else if (currentState.view === 'menu') renderMenu();
            else if (currentState.view === 'quiz') renderQuiz();
            else if (currentState.view === 'result') renderResult();
        }

        // --- Global Actions ---
        window.startQuiz = async (type) => { 
            currentState.quizType = type;
            let questions = [];
            if(type === 'pretest' && currentState.pretestQuestions) {
                questions = currentState.pretestQuestions;
            } else if (type === 'posttest' && currentState.posttestQuestions) {
                questions = currentState.posttestQuestions;
            } else {
                renderLoading(`กำลังโหลดข้อสอบ ${type === 'pretest' ? 'Pre-test' : 'Post-test'}...`);
                questions = await fetchQuestions(type);
                if(type === 'pretest') currentState.pretestQuestions = questions;
                else currentState.posttestQuestions = questions;
            }

            if(questions.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'ไม่พบข้อสอบ',
                    text: 'ยังไม่มีข้อสอบในระบบ หรือเกิดข้อผิดพลาดในการโหลด',
                    confirmButtonColor: '#0369a1'
                });
                renderMenu();
                return;
            }

            currentState.currentExamData = questions;
            currentState.currentQuestionIndex = 0; 
            currentState.answers = {}; 
            currentState.score = 0; 
            
            if(type === 'pretest') currentState.pretestData.isDone = false;
            if(type === 'posttest') currentState.posttestData.isDone = false;
            
            currentState.view = 'quiz'; 
            renderApp(); 
        };

        window.reviewQuiz = async (type) => { 
            currentState.quizType = type;
            if(type === 'pretest' && !currentState.pretestQuestions) {
                 renderLoading('กำลังโหลดข้อมูล...');
                 currentState.pretestQuestions = await fetchQuestions(type);
            }
            if(type === 'posttest' && !currentState.posttestQuestions) {
                 renderLoading('กำลังโหลดข้อมูล...');
                 currentState.posttestQuestions = await fetchQuestions(type);
            }

            currentState.currentExamData = type === 'pretest' ? currentState.pretestQuestions : currentState.posttestQuestions;
            
            if(!currentState.currentExamData || currentState.currentExamData.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'ไม่พบข้อมูล',
                    text: 'ไม่สามารถโหลดข้อมูลเพื่อดูเฉลยได้',
                    confirmButtonColor: '#0369a1'
                });
                renderMenu();
                return;
            }

            currentState.currentQuestionIndex = 0;
            if(type === 'pretest') currentState.answers = currentState.pretestData.answers;
            if(type === 'posttest') currentState.answers = currentState.posttestData.answers;
            
            if(type === 'pretest') currentState.pretestData.isDone = true;
            if(type === 'posttest') currentState.posttestData.isDone = true;
            
            currentState.view = 'quiz'; 
            renderApp(); 
        };

        window.selectAnswer = (i) => { currentState.answers[currentState.currentQuestionIndex] = i; renderQuiz(); };
        window.nextQuestion = () => { if(currentState.currentQuestionIndex < currentState.currentExamData.length - 1) { currentState.currentQuestionIndex++; renderQuiz(); } };
        window.prevQuestion = () => { if(currentState.currentQuestionIndex > 0) { currentState.currentQuestionIndex--; renderQuiz(); } };
        window.backToMenu = () => { currentState.view = 'menu'; renderApp(); };
        
        window.submitQuiz = async () => {
            const result = await Swal.fire({
                title: 'ยืนยันการส่งคำตอบ?',
                text: "กรุณาตรวจสอบความเรียบร้อยก่อนส่ง",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#0369a1',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'ยืนยันส่งคำตอบ',
                cancelButtonText: 'กลับไปตรวจสอบ'
            });

            if (!result.isConfirmed) return;

            const questions = currentState.currentExamData;
            let score = 0;
            questions.forEach((q, idx) => { if(currentState.answers[idx] === q.correctAnswer) score++; });
            currentState.score = score;
            
            if (currentState.quizType === 'pretest') {
                currentState.pretestData = { isDone: true, score: score, answers: {...currentState.answers} };
            } else {
                currentState.posttestData = { isDone: true, score: score, answers: {...currentState.answers} };
            }

            renderLoading('กำลังบันทึกคะแนนลงระบบ...');
            await saveUserData({ 
                user: currentState.user, userId: currentState.userId,
                realName: currentState.realName, studentId: currentState.studentId,
                quizType: currentState.quizType, score: score, 
                total: questions.length, answers: currentState.answers 
            });
            currentState.view = 'result';
            renderApp();
        };

        renderLogin();
    </script>
</body>
</html>
